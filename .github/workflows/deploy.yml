name: Build and Deploy

on:
  push:
    branches:
      - main

permissions:
  contents: write  # ✅ 권한 추가


jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. 리포지토리 체크아웃
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      # 2. Node.js 설정 (버전은 필요에 따라 수정 가능)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3. 의존성 설치
      - name: Install dependencies
        run: npm install

      # 4. 빌드 실행
      - name: Build Project
        run: npm run build

      # 5. GitHub Pages에 배포
      - name: Deploy to GitHub Pages
        env:
          GITHUB_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}  # ✅ GitHub 인증을 위한 토큰
#          TARGET_REPO: "ipcian/ipcianreact.github.io"  # ✅ 대상 GitHub 저장소
          BRANCH: "main"  # ✅ 배포할 브랜치
          COMMIT_AUTHOR: "github-actions[bot]"  # ✅ 커밋 작성자
          COMMIT_EMAIL: "ipciancompany@gmail.com"  # ✅ 커밋 이메일
        run: |
          git config --global user.email "COMMIT_EMAIL"
          git config --global user.name "$COMMIT_AUTHOR"
          git config --global credential.helper store
          
          git clone https://github.com/ipcian/ipcianreact.github.io.git
          cd ipcianreact.github.io
          echo "기존 파일 삭제 후 추가"
          if [ "$(git ls-files)" ]; then
            echo "Git에서 추적되는 파일이 존재합니다. 내부 파일을 삭제합니다."
            git rm -r --cached . # Git에서 관리 파일 제거
          else
            echo "Git에서 추적되는 파일이 없습니다. 디스트 폴더의 내용물을 복사합니다."
          fi
          
          cp -r ../dist/* ./
          git add .
          git commit -m '제발'
          git push https://x-access-token:${{ secrets.TARGET_REPO_TOKEN }}@github.com/ipcian/ipcianreact.github.io.git
          
          # 나머지 삭제 처리
          cd ../
          rm -rf node_modules
          rm -rf dist
          rm -rf ipcianreact.github.io


